name: Deploy to Production

on:
  push:
    branches: [ main ]
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy'
        required: true

env:
  PYTHON_VERSION: '3.11'
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/rag-system

jobs:
  # ============================================
  # REQUIRE STAGING APPROVAL
  # ============================================
  approve-staging:
    name: Verify Staging Success
    runs-on: ubuntu-latest

    steps:
      - name: Check staging health
        run: |
          # Verify staging is healthy
          curl -f https://staging-api.yourdomain.com/health || exit 1
          
          echo "✅ Staging environment is healthy"

  # ============================================
  # FULL TEST SUITE
  # ============================================
  test:
    name: Full Test Suite
    runs-on: ubuntu-latest
    needs: approve-staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run all tests
        run: |
          pip install -r requirements-dev.txt
          pytest tests/ -v --cov=src --cov-report=xml
          
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: production

  # ============================================
  # BUILD PRODUCTION IMAGE
  # ============================================
  build:
    name: Build Production Image
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION=$(cat VERSION)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
            ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:production
          cache-from: type=registry,ref=${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

  # ============================================
  # DEPLOY TO PRODUCTION (BLUE-GREEN)
  # ============================================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: production
      url: https://yourdomain.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Blue-Green Deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            cd /opt/rag-system
            
            # Pull latest
            git checkout main
            git pull origin main
            
            # Blue-Green deployment
            ./scripts/deploy/deploy-production.sh
            
            # Wait for new containers
            sleep 60
            
            # Health check
            curl -f https://api.yourdomain.com/health || exit 1
            
            # Run smoke tests
            ./scripts/deploy/smoke-test.sh production
            
            # If successful, remove old containers
            docker-compose -f docker/docker-compose.yml down --remove-orphans

      - name: Create release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          body: |
            Production Release ${{ github.ref_name }}
            
            **Changes:**
            - See CHANGELOG.md for details
            
            **Docker Image:**
            `${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}`
          draft: false
          prerelease: false

      - name: Notify success
        run: |
          echo "✅ Production deployment successful!"
          # Add Slack/Email notification

  # ============================================
  # ROLLBACK ON FAILURE
  # ============================================
  rollback:
    name: Rollback Production
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()

    steps:
      - name: Emergency rollback
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            cd /opt/rag-system
            ./scripts/deploy/rollback.sh production
            
      - name: Notify failure
        run: |
          echo "❌ Production deployment failed! Rollback initiated."
          # Add urgent Slack/PagerDuty notification